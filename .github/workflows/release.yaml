---
name: Publish charts to GHCR (OCI)

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Login to GHCR
        env:
          HELM_EXPERIMENTAL_OCI: "1"
        run: |
          echo "${{ github.token }}" | helm registry login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Publish changed charts
        env:
          REGISTRY: oci://ghcr.io/joejulian/charts
        run: |
          set -euo pipefail

          before="${{ github.event.before }}"
          after="${{ github.sha }}"

          # Find chart directories touched by this push
          charts=$(
            git diff --name-only "$before" "$after" \
              | awk -F/ '$1=="charts" && $2!="" {print $2}' \
              | sort -u
          )

          if [[ -z "${charts}" ]]; then
            echo "No chart changes detected."
            exit 0
          fi

          for c in $charts; do
            dir="charts/$c"
            [[ -f "$dir/Chart.yaml" ]] || continue

            echo "Publishing $dir"
            helm dependency update "$dir"
            pkg="$(helm package "$dir" --destination /tmp | awk '{print $NF}')"
            helm push "$pkg" "$REGISTRY"
          done
